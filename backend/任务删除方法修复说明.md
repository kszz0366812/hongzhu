# 任务删除方法修复说明

## 问题描述

任务删除方法调用失败，原因是 `updateById(taskTarget)` 这个方法并不会更新 `deleted` 字段。

## 问题根源

1. **MyBatis-Plus 逻辑删除配置**：
   - 在 `application.yml` 中配置了逻辑删除：
     ```yaml
     mybatis-plus:
       global-config:
         db-config:
           logic-delete-field: deleted
           logic-delete-value: 1
           logic-not-delete-value: 0
     ```

2. **BaseEntity 中的 @TableLogic 注解**：
   - `BaseEntity` 中的 `deleted` 字段使用了 `@TableLogic` 注解
   - 这个注解告诉 MyBatis-Plus 这是一个逻辑删除字段

3. **updateById() 方法的限制**：
   - `updateById()` 方法会忽略带有 `@TableLogic` 注解的字段
   - 这是 MyBatis-Plus 的设计，防止意外更新逻辑删除字段

## 错误的实现方式

```java
@Override
@Transactional(rollbackFor = Exception.class)
public void delete(Long id) {
    TaskTarget taskTarget = getById(id);
    if (taskTarget != null) {
        taskTarget.setDeleted(1);  // 这个设置不会生效
        EntityUtils.setUpdateInfo(taskTarget);
        updateById(taskTarget);    // 不会更新 deleted 字段
    }
}
```

## 正确的解决方案

直接使用 MyBatis-Plus 提供的默认删除方法，无需自定义删除方法：

### 方案一：删除自定义删除方法，直接使用默认方法

1. **删除服务接口中的自定义删除方法**
2. **删除服务实现类中的自定义删除方法**  
3. **控制器直接调用 `removeById()` 方法**

```java
// 控制器中直接调用
@Operation(summary = "删除任务目标")
@RequestMapping("/delete/{id}")
public Result<Void> delete(@PathVariable Long id) {
    taskTargetService.removeById(id);  // 直接使用默认方法
    return Result.success();
}
```

### 方案二：保留自定义删除方法（如果需要特殊逻辑）

```java
@Override
@Transactional(rollbackFor = Exception.class)
public void delete(Long id) {
    // 使用 MyBatis-Plus 的逻辑删除方法，会自动设置 deleted=1
    removeById(id);
}
```

## 修复的文件

### 已简化的服务接口（删除自定义删除方法）
1. **TaskTargetService.java** - 任务目标服务接口
2. **PvTemplateService.java** - 报表模板服务接口  
3. **ItfTemplateService.java** - 接口模板服务接口
4. **UserService.java** - 用户服务接口
5. **ReportService.java** - 报告服务接口
6. **ProjectTaskService.java** - 项目任务服务接口
7. **ProjectService.java** - 项目服务接口
8. **ProjectProgressService.java** - 项目进度服务接口

### 已简化的服务实现类（删除自定义删除方法）
1. **TaskTargetServiceImpl.java** - 任务目标服务实现
2. **PvTemplateServiceImpl.java** - 报表模板服务实现  
3. **ItfTemplateServiceImpl.java** - 接口模板服务实现
4. **UserServiceImpl.java** - 用户服务实现
5. **ReportServiceImpl.java** - 报告服务实现
6. **ProjectTaskServiceImpl.java** - 项目任务服务实现
7. **ProjectServiceImpl.java** - 项目服务实现
8. **ProjectProgressServiceImpl.java** - 项目进度服务实现

### 已修改的控制器（直接调用默认删除方法）
1. **TaskTargetController.java** - 任务目标控制器
2. **PvTemplateController.java** - 报表模板控制器  
3. **ItfTemplateController.java** - 接口模板控制器
4. **UserController.java** - 用户控制器
5. **ReportController.java** - 报告控制器
6. **ProjectTaskController.java** - 项目任务控制器
7. **ProjectController.java** - 项目控制器
8. **ProjectProgressController.java** - 项目进度控制器

### 保留自定义删除方法的服务（有特殊逻辑）
1. **RoleServiceImpl.deleteRole()** - 删除角色菜单关联
2. **MenuServiceImpl.deleteMenu()** - 删除子菜单
3. **DeptServiceImpl.deleteDept()** - 删除子部门
4. **DataDictionaryServiceImpl.delete()** - 数据字典删除
5. **AttachmentServiceImpl.deleteAttachment()** - 删除附件文件

## MyBatis-Plus 逻辑删除机制

- `removeById()`: 根据 ID 进行逻辑删除
- `removeByIds()`: 根据 ID 列表进行批量逻辑删除
- `remove()`: 根据条件进行逻辑删除
- `removeByMap()`: 根据 Map 条件进行逻辑删除

## 注意事项

1. 使用 `@TableLogic` 注解的字段会被 MyBatis-Plus 自动处理
2. 查询时会自动添加 `deleted = 0` 的条件
3. 删除时会自动设置 `deleted = 1`
4. `updateById()` 方法不会更新 `@TableLogic` 字段
5. 直接使用 `IService` 提供的默认方法可以减少代码冗余
6. 如果删除操作需要特殊逻辑（如删除关联数据），可以保留自定义删除方法

## 验证方法

1. 调用删除接口
2. 检查数据库中对应记录的 `deleted` 字段是否被设置为 1
3. 查询接口应该不再返回已删除的记录 