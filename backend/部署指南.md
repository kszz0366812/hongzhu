# 报告管理系统部署指南

## 环境准备

### 1. 系统要求
- **操作系统**: Linux/Windows/macOS
- **Java版本**: JDK 1.8+
- **数据库**: MySQL 8.0+
- **缓存**: Redis 6.0+
- **构建工具**: Maven 3.6+

### 2. 软件安装

#### 安装JDK
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install openjdk-8-jdk

# CentOS/RHEL
sudo yum install java-1.8.0-openjdk

# 验证安装
java -version
```

#### 安装MySQL
```bash
# Ubuntu/Debian
sudo apt install mysql-server

# CentOS/RHEL
sudo yum install mysql-server

# 启动MySQL
sudo systemctl start mysqld
sudo systemctl enable mysqld

# 安全配置
sudo mysql_secure_installation
```

#### 安装Redis
```bash
# Ubuntu/Debian
sudo apt install redis-server

# CentOS/RHEL
sudo yum install redis

# 启动Redis
sudo systemctl start redis
sudo systemctl enable redis
```

#### 安装Maven
```bash
# 下载Maven
wget https://archive.apache.org/dist/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz

# 解压
tar -xzf apache-maven-3.6.3-bin.tar.gz
sudo mv apache-maven-3.6.3 /opt/maven

# 配置环境变量
echo 'export MAVEN_HOME=/opt/maven' >> ~/.bashrc
echo 'export PATH=$PATH:$MAVEN_HOME/bin' >> ~/.bashrc
source ~/.bashrc

# 验证安装
mvn -version
```

## 数据库配置

### 1. 创建数据库
```sql
-- 登录MySQL
mysql -u root -p

-- 创建数据库
CREATE DATABASE minhzrcms CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建用户
CREATE USER 'minhzrcms'@'localhost' IDENTIFIED BY 'your_password';

-- 授权
GRANT ALL PRIVILEGES ON minhzrcms.* TO 'minhzrcms'@'localhost';
FLUSH PRIVILEGES;
```

### 2. 执行SQL脚本
```bash
# 执行数据库初始化脚本
mysql -u minhzrcms -p minhzrcms < init.sql
```

## 项目部署

### 1. 获取项目代码
```bash
# 克隆项目
git clone https://github.com/your-repo/minhzrcms.git
cd minhzrcms
```

### 2. 修改配置文件
编辑 `src/main/resources/application.yml`:

```yaml
server:
  port: 8080

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/minhzrcms?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai
    username: minhzrcms
    password: your_password
    driver-class-name: com.mysql.cj.jdbc.Driver
  
  redis:
    host: localhost
    port: 6379
    password: 
    database: 0

# 微信小程序配置
wx:
  miniapp:
    appid: your_appid
    secret: your_secret
    token: your_token
    aesKey: your_aes_key
    msgDataFormat: JSON

# JWT配置
jwt:
  secret: your_jwt_secret_key_here
  expiration: 604800

# 文件上传配置
upload:
  path: /app/uploads/
  max-size: 10485760
```

### 3. 编译打包
```bash
# 清理并编译
mvn clean compile

# 运行测试
mvn test

# 打包
mvn clean package -DskipTests
```

### 4. 运行应用
```bash
# 直接运行
java -jar target/minhzrcms-1.0.0.jar

# 后台运行
nohup java -jar target/minhzrcms-1.0.0.jar > app.log 2>&1 &

# 查看进程
ps aux | grep minhzrcms
```

## Docker部署

### 1. 创建Dockerfile
```dockerfile
FROM openjdk:8-jre-alpine

WORKDIR /app

COPY target/minhzrcms-1.0.0.jar app.jar

EXPOSE 8080

CMD ["java", "-jar", "app.jar"]
```

### 2. 创建docker-compose.yml
```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: minhzrcms
      MYSQL_USER: minhzrcms
      MYSQL_PASSWORD: your_password
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    command: --default-authentication-plugin=mysql_native_password

  redis:
    image: redis:6.0-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  app:
    build: .
    ports:
      - "8080:8080"
    depends_on:
      - mysql
      - redis
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/minhzrcms?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai
      SPRING_DATASOURCE_USERNAME: minhzrcms
      SPRING_DATASOURCE_PASSWORD: your_password
      SPRING_REDIS_HOST: redis
    volumes:
      - upload_data:/app/uploads

volumes:
  mysql_data:
  redis_data:
  upload_data:
```

### 3. 启动服务
```bash
# 构建并启动
docker-compose up -d

# 查看日志
docker-compose logs -f app

# 停止服务
docker-compose down
```

## Nginx配置

### 1. 安装Nginx
```bash
# Ubuntu/Debian
sudo apt install nginx

# CentOS/RHEL
sudo yum install nginx
```

### 2. 配置Nginx
创建配置文件 `/etc/nginx/sites-available/minhzrcms`:

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /uploads/ {
        alias /app/uploads/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
```

### 3. 启用配置
```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/minhzrcms /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx
```

## 系统服务配置

### 1. 创建系统服务
创建文件 `/etc/systemd/system/minhzrcms.service`:

```ini
[Unit]
Description=MinHzRcms Application
After=network.target

[Service]
Type=simple
User=minhzrcms
WorkingDirectory=/app
ExecStart=/usr/bin/java -jar /app/minhzrcms-1.0.0.jar
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

### 2. 启动服务
```bash
# 创建用户
sudo useradd -r -s /bin/false minhzrcms

# 创建目录
sudo mkdir -p /app
sudo chown minhzrcms:minhzrcms /app

# 复制文件
sudo cp target/minhzrcms-1.0.0.jar /app/

# 启动服务
sudo systemctl daemon-reload
sudo systemctl enable minhzrcms
sudo systemctl start minhzrcms

# 查看状态
sudo systemctl status minhzrcms
```

## 监控配置

### 1. 应用监控
使用Spring Boot Actuator进行监控:

```yaml
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  endpoint:
    health:
      show-details: always
```

### 2. 日志配置
配置Logback日志:

```xml
<configuration>
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>/app/logs/minhzrcms.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>/app/logs/minhzrcms.%d{yyyy-MM-dd}.log</fileNamePattern>
            <maxHistory>30</maxHistory>
        </rollingPolicy>
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>

    <root level="INFO">
        <appender-ref ref="FILE"/>
    </root>
</configuration>
```

## 备份策略

### 1. 数据库备份
创建备份脚本 `/app/scripts/backup.sh`:

```bash
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/app/backups"
DB_NAME="minhzrcms"

mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -u minhzrcms -p'your_password' $DB_NAME > $BACKUP_DIR/db_backup_$DATE.sql

# 压缩备份文件
gzip $BACKUP_DIR/db_backup_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "db_backup_*.sql.gz" -mtime +7 -delete
```

### 2. 文件备份
```bash
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/app/backups"
UPLOAD_DIR="/app/uploads"

# 备份上传文件
tar -czf $BACKUP_DIR/uploads_backup_$DATE.tar.gz -C $UPLOAD_DIR .

# 删除7天前的备份
find $BACKUP_DIR -name "uploads_backup_*.tar.gz" -mtime +7 -delete
```

### 3. 设置定时任务
```bash
# 编辑crontab
crontab -e

# 添加定时任务（每天凌晨2点执行备份）
0 2 * * * /app/scripts/backup.sh
```

## 故障排查

### 1. 常见问题

#### 应用无法启动
```bash
# 检查端口占用
netstat -tlnp | grep 8080

# 检查日志
tail -f /app/logs/minhzrcms.log

# 检查Java进程
ps aux | grep java
```

#### 数据库连接失败
```bash
# 检查MySQL服务状态
sudo systemctl status mysqld

# 测试数据库连接
mysql -u minhzrcms -p -h localhost

# 检查防火墙
sudo ufw status
```

#### Redis连接失败
```bash
# 检查Redis服务状态
sudo systemctl status redis

# 测试Redis连接
redis-cli ping

# 检查Redis配置
cat /etc/redis/redis.conf
```

### 2. 性能优化

#### JVM调优
```bash
# 调整JVM参数
java -Xms512m -Xmx1024m -XX:+UseG1GC -jar app.jar
```

#### 数据库优化
```sql
-- 检查慢查询
SHOW VARIABLES LIKE 'slow_query_log';
SHOW VARIABLES LIKE 'long_query_time';

-- 优化表
OPTIMIZE TABLE sys_user;
```

#### Redis优化
```bash
# 检查内存使用
redis-cli info memory

# 清理过期键
redis-cli FLUSHDB
```

## 安全配置

### 1. 防火墙配置
```bash
# 开放必要端口
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 8080/tcp

# 启用防火墙
sudo ufw enable
```

### 2. SSL证书配置
```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx

# 获取SSL证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo crontab -e
# 添加：0 12 * * * /usr/bin/certbot renew --quiet
```

### 3. 安全加固
```bash
# 更新系统
sudo apt update && sudo apt upgrade

# 安装安全工具
sudo apt install fail2ban

# 配置SSH
sudo nano /etc/ssh/sshd_config
# 修改：PermitRootLogin no
# 修改：PasswordAuthentication no
```

## 维护指南

### 1. 日常维护
- 定期检查系统资源使用情况
- 监控应用日志和错误信息
- 备份重要数据
- 更新系统和安全补丁

### 2. 版本更新
```bash
# 停止服务
sudo systemctl stop minhzrcms

# 备份当前版本
cp /app/minhzrcms-1.0.0.jar /app/backups/

# 部署新版本
cp target/minhzrcms-1.1.0.jar /app/minhzrcms-1.0.0.jar

# 启动服务
sudo systemctl start minhzrcms

# 检查服务状态
sudo systemctl status minhzrcms
```

### 3. 监控告警
- 设置系统资源监控
- 配置应用异常告警
- 建立故障响应机制
- 定期进行系统巡检 